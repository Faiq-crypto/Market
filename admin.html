<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BasedMarket | Admin Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Space Grotesk', 'sans-serif'] },
                    colors: { bg: '#020202', card: '#0C0C0C', primary: '#FF2E2E', accent: '#00FF94' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020202; color: white; }
        .glass { background: rgba(20, 20, 20, 0.9); border: 1px solid #333; }
        input, select { background: #111; border: 1px solid #333; color: white; }
        input:focus, select:focus { outline: none; border-color: #FF2E2E; }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center p-4">

    <!-- AUTH SCREEN -->
    <div id="authScreen" class="text-center space-y-6">
        <div class="w-20 h-20 bg-primary/10 rounded-2xl flex items-center justify-center mx-auto border border-primary/20 shadow-[0_0_30px_rgba(255,46,46,0.2)]">
            <i class="fa-solid fa-shield-halved text-4xl text-primary"></i>
        </div>
        <h1 class="text-3xl font-display font-bold">Admin Protocol</h1>
        <p class="text-gray-500 text-sm max-w-xs mx-auto">Connect the authorized owner wallet to access settlement controls.</p>
        <button onclick="connectAdmin()" class="bg-white text-black font-bold py-3 px-8 rounded-full hover:scale-105 transition-transform">
            Connect Wallet
        </button>
    </div>

    <!-- DASHBOARD (Hidden) -->
    <div id="dashboard" class="hidden w-full max-w-md space-y-6">
        
        <!-- Header -->
        <div class="flex justify-between items-center border-b border-gray-800 pb-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center text-black font-bold"><i class="fa-solid fa-gavel"></i></div>
                <div>
                    <h2 class="font-bold text-lg leading-none">Settlement</h2>
                    <span class="text-[10px] text-green-500 font-mono">‚óè SYSTEM ACTIVE</span>
                </div>
            </div>
            <div class="text-right">
                <div class="text-[10px] text-gray-500 uppercase">Connected As</div>
                <div class="font-mono text-xs text-primary" id="adminAddress">0x00...000</div>
            </div>
        </div>

        <!-- Settlement Form -->
        <div class="glass p-6 rounded-2xl space-y-5">
            
            <!-- Asset Selection -->
            <div class="space-y-2">
                <label class="text-xs font-bold text-gray-400 uppercase">1. Select Asset Pool</label>
                <div class="grid grid-cols-2 gap-2">
                    <label class="cursor-pointer">
                        <input type="radio" name="asset" value="BTC" class="peer sr-only" checked>
                        <div class="p-3 rounded-xl border border-[#333] bg-[#050505] peer-checked:border-primary peer-checked:bg-primary/10 peer-checked:text-primary transition-all text-center font-bold text-sm">
                            BTC / USD
                        </div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="asset" value="LTC" class="peer sr-only">
                        <div class="p-3 rounded-xl border border-[#333] bg-[#050505] peer-checked:border-primary peer-checked:bg-primary/10 peer-checked:text-primary transition-all text-center font-bold text-sm">
                            LTC / USD
                        </div>
                    </label>
                </div>
            </div>

            <!-- Winner Selection -->
            <div class="space-y-2">
                <label class="text-xs font-bold text-gray-400 uppercase">2. Declare Winner</label>
                <select id="winningSide" class="w-full p-4 rounded-xl font-bold">
                    <option value="BEAR">üêª BEAR (Price Dropped)</option>
                    <option value="NEUTRAL">‚öñÔ∏è NEUTRAL (Price Flat)</option>
                    <option value="BULL">üêÇ BULL (Price Rose)</option>
                </select>
            </div>

            <!-- Warning -->
            <div class="bg-yellow-900/20 border border-yellow-600/30 p-3 rounded-lg flex gap-3 items-start">
                <i class="fa-solid fa-triangle-exclamation text-yellow-500 mt-0.5"></i>
                <div class="text-[10px] text-yellow-200/80">
                    <span class="font-bold text-yellow-500">Warning:</span> This action is irreversible. 
                    It will calculate payouts (1.88x or 3.88x), update the Google Sheet, and mark rounds as "WON" or "LOST".
                </div>
            </div>

            <!-- Submit -->
            <button onclick="executeSettlement()" id="btnExecute" class="w-full bg-primary hover:bg-red-600 text-white font-bold py-4 rounded-xl shadow-[0_0_20px_rgba(255,46,46,0.4)] transition-all active:scale-95">
                SETTLE ROUND & PAYOUT
            </button>
        </div>

        <!-- Status Log -->
        <div id="statusLog" class="text-center text-xs font-mono text-gray-500"></div>
    </div>

    <script>
        // ================= CONFIGURATION =================
        // MUST MATCH YOUR GOOGLE SCRIPT URL
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby3NQQBOQd8wMHzrQRx33xXGjKk95V1RrtmnfFgCf3D0re0fV7fehHFsRcWjvvchSmoaQ/exec"; 
        
        // MUST MATCH THE ADDRESS IN YOUR GOOGLE SCRIPT CONFIG
        const ADMIN_WALLET = "0x91A6d3FFFe7491DeB69130523B48ed2f5336FE6b"; 
        // =================================================

        let provider, signer, userAddress;

        async function connectAdmin() {
            if (!window.ethereum) return alert("No Wallet Found");
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                if(userAddress.toLowerCase() !== ADMIN_WALLET.toLowerCase()) {
                    alert("ACCESS DENIED: Wallet is not authorized admin.");
                    return;
                }

                // Show Dashboard
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('adminAddress').innerText = userAddress;

            } catch(e) {
                alert("Connection Error: " + e.message);
            }
        }

        async function executeSettlement() {
            const asset = document.querySelector('input[name="asset"]:checked').value;
            const winner = document.getElementById('winningSide').value;
            const btn = document.getElementById('btnExecute');
            const log = document.getElementById('statusLog');

            if(!confirm(`CONFIRM SETTLEMENT:\n\nAsset: ${asset}\nWinner: ${winner}\n\nProceed with payouts?`)) return;

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> PROCESSING PAYOUTS...';
            log.innerText = "Contacting Google Sheet Database...";
            log.className = "text-center text-xs font-mono text-yellow-500 animate-pulse";

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: "POST",
                    mode: "no-cors", // Important for Google Scripts
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        action: "settle_round",
                        user: userAddress, // Sends admin address for security verification on server
                        asset: asset,
                        winningSide: winner
                    })
                });

                // Since mode is no-cors, we can't read the response JSON directly, 
                // but if it doesn't throw error, request went through.
                
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = 'SETTLEMENT COMPLETE <i class="fa-solid fa-check ml-2"></i>';
                    btn.className = "w-full bg-green-500 text-black font-bold py-4 rounded-xl transition-all";
                    
                    log.innerText = `Success! ${asset} bets settled. Winners credited.`;
                    log.className = "text-center text-xs font-mono text-green-500";

                    // Reset button after 3 seconds
                    setTimeout(() => {
                        btn.innerHTML = 'SETTLE ROUND & PAYOUT';
                        btn.className = "w-full bg-primary hover:bg-red-600 text-white font-bold py-4 rounded-xl shadow-[0_0_20px_rgba(255,46,46,0.4)] transition-all active:scale-95";
                    }, 3000);
                }, 2000);

            } catch(e) {
                console.error(e);
                btn.disabled = false;
                btn.innerText = "ERROR - TRY AGAIN";
                log.innerText = "Connection Failed. Check Console.";
                log.className = "text-center text-xs font-mono text-red-500";
            }
        }
    </script>
</body>
</html>